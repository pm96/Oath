{"version":3,"names":["_firestore","require","_zod","_habitStreaks","FirestoreTimestampSchema","exports","z","custom","val","Timestamp","CompletionDocumentSchema","object","habitId","string","min","userId","completedAt","timezone","notes","optional","difficulty","enum","createdAt","StreakDocumentSchema","currentStreak","number","int","bestStreak","lastCompletionDate","regex","streakStartDate","freezesAvailable","freezesUsed","milestones","array","days","positive","achievedAt","celebrated","boolean","updatedAt","AnalyticsDocumentSchema","totalCompletions","completionRate30Days","max","averageStreakLength","bestDayOfWeek","consistencyScore","lastUpdated","generateCompletionId","timestamp","seconds","generateStreakId","generateAnalyticsId","getCollectionPath","collection","FIRESTORE_COLLECTIONS","transformCompletionToFirestore","completion","now","transformFirestoreToCompletion","id","data","transformStreakToFirestore","streak","transformFirestoreToStreak","transformAnalyticsToFirestore","analytics","transformFirestoreToAnalytics","validateCompletionDocument","safeParse","success","validateStreakDocument","validateAnalyticsDocument","validateUserOwnership","documentUserId","validateTimestampRecency","maxHoursOld","arguments","length","undefined","diffMs","toMillis","diffHours","SECURITY_RULES_DOCUMENTATION","completions","read","write","validation","streaks"],"sources":["habitStreakSchemas.ts"],"sourcesContent":["import { Timestamp } from \"firebase/firestore\";\nimport { z } from \"zod\";\nimport {\n    FIRESTORE_COLLECTIONS,\n    HabitAnalytics,\n    HabitCompletion,\n    HabitStreak\n} from \"../../types/habit-streaks\";\n\n/**\n * Firestore collection schemas and validation utilities for habit streaks\n */\n\n// Firestore document validation schemas\nexport const FirestoreTimestampSchema = z.custom<Timestamp>((val) => {\n    return val instanceof Timestamp;\n}, \"Must be a Firestore Timestamp\");\n\n// Completion document schema for Firestore\nexport const CompletionDocumentSchema = z.object({\n    habitId: z.string().min(1),\n    userId: z.string().min(1),\n    completedAt: FirestoreTimestampSchema,\n    timezone: z.string().min(1),\n    notes: z.string().optional(),\n    difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n    createdAt: FirestoreTimestampSchema,\n});\n\n// Streak document schema for Firestore\nexport const StreakDocumentSchema = z.object({\n    habitId: z.string().min(1),\n    userId: z.string().min(1),\n    currentStreak: z.number().int().min(0),\n    bestStreak: z.number().int().min(0),\n    lastCompletionDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),\n    streakStartDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),\n    freezesAvailable: z.number().int().min(0),\n    freezesUsed: z.number().int().min(0),\n    milestones: z.array(\n        z.object({\n            days: z.number().int().positive(),\n            achievedAt: FirestoreTimestampSchema,\n            celebrated: z.boolean(),\n        }),\n    ),\n    updatedAt: FirestoreTimestampSchema,\n});\n\n// Analytics document schema for Firestore\nexport const AnalyticsDocumentSchema = z.object({\n    habitId: z.string().min(1),\n    userId: z.string().min(1),\n    totalCompletions: z.number().int().min(0),\n    completionRate30Days: z.number().min(0).max(100),\n    averageStreakLength: z.number().min(0),\n    bestDayOfWeek: z.string().min(1),\n    consistencyScore: z.number().min(0).max(100),\n    lastUpdated: FirestoreTimestampSchema,\n});\n\n// Document ID generators\nexport const generateCompletionId = (\n    userId: string,\n    habitId: string,\n    timestamp: Timestamp,\n): string => {\n    return `${userId}_${habitId}_${timestamp.seconds}`;\n};\n\nexport const generateStreakId = (userId: string, habitId: string): string => {\n    return `${userId}_${habitId}`;\n};\n\nexport const generateAnalyticsId = (\n    userId: string,\n    habitId: string,\n): string => {\n    return `${userId}_${habitId}`;\n};\n\n// Collection references helpers\nexport const getCollectionPath = (\n    collection: keyof typeof FIRESTORE_COLLECTIONS,\n): string => {\n    return FIRESTORE_COLLECTIONS[collection];\n};\n\n// Data transformation utilities\nexport const transformCompletionToFirestore = (completion: HabitCompletion) => {\n    return {\n        habitId: completion.habitId,\n        userId: completion.userId,\n        completedAt: completion.completedAt,\n        timezone: completion.timezone,\n        notes: completion.notes,\n        difficulty: completion.difficulty,\n        createdAt: Timestamp.now(),\n    };\n};\n\nexport const transformFirestoreToCompletion = (\n    id: string,\n    data: any,\n): HabitCompletion => {\n    return {\n        id,\n        habitId: data.habitId,\n        userId: data.userId,\n        completedAt: data.completedAt,\n        timezone: data.timezone,\n        notes: data.notes,\n        difficulty: data.difficulty,\n    };\n};\n\nexport const transformStreakToFirestore = (streak: HabitStreak) => {\n    return {\n        habitId: streak.habitId,\n        userId: streak.userId,\n        currentStreak: streak.currentStreak,\n        bestStreak: streak.bestStreak,\n        lastCompletionDate: streak.lastCompletionDate,\n        streakStartDate: streak.streakStartDate,\n        freezesAvailable: streak.freezesAvailable,\n        freezesUsed: streak.freezesUsed,\n        milestones: streak.milestones,\n        updatedAt: Timestamp.now(),\n    };\n};\n\nexport const transformFirestoreToStreak = (data: any): HabitStreak => {\n    return {\n        habitId: data.habitId,\n        userId: data.userId,\n        currentStreak: data.currentStreak,\n        bestStreak: data.bestStreak,\n        lastCompletionDate: data.lastCompletionDate,\n        streakStartDate: data.streakStartDate,\n        freezesAvailable: data.freezesAvailable,\n        freezesUsed: data.freezesUsed,\n        milestones: data.milestones || [],\n    };\n};\n\nexport const transformAnalyticsToFirestore = (analytics: HabitAnalytics) => {\n    return {\n        habitId: analytics.habitId,\n        userId: analytics.userId,\n        totalCompletions: analytics.totalCompletions,\n        completionRate30Days: analytics.completionRate30Days,\n        averageStreakLength: analytics.averageStreakLength,\n        bestDayOfWeek: analytics.bestDayOfWeek,\n        consistencyScore: analytics.consistencyScore,\n        lastUpdated: analytics.lastUpdated,\n    };\n};\n\nexport const transformFirestoreToAnalytics = (data: any): HabitAnalytics => {\n    return {\n        habitId: data.habitId,\n        userId: data.userId,\n        totalCompletions: data.totalCompletions,\n        completionRate30Days: data.completionRate30Days,\n        averageStreakLength: data.averageStreakLength,\n        bestDayOfWeek: data.bestDayOfWeek,\n        consistencyScore: data.consistencyScore,\n        lastUpdated: data.lastUpdated,\n    };\n};\n\n// Validation functions\nexport const validateCompletionDocument = (data: any): boolean => {\n    return CompletionDocumentSchema.safeParse(data).success;\n};\n\nexport const validateStreakDocument = (data: any): boolean => {\n    return StreakDocumentSchema.safeParse(data).success;\n};\n\nexport const validateAnalyticsDocument = (data: any): boolean => {\n    return AnalyticsDocumentSchema.safeParse(data).success;\n};\n\n// Security validation helpers\nexport const validateUserOwnership = (\n    userId: string,\n    documentUserId: string,\n): boolean => {\n    return userId === documentUserId;\n};\n\nexport const validateTimestampRecency = (\n    timestamp: Timestamp,\n    maxHoursOld: number = 24,\n): boolean => {\n    const now = Timestamp.now();\n    const diffMs = now.toMillis() - timestamp.toMillis();\n    const diffHours = diffMs / (1000 * 60 * 60);\n\n    return diffHours <= maxHoursOld;\n};\n\n// Firestore security rules helpers (for documentation)\nexport const SECURITY_RULES_DOCUMENTATION = {\n    completions: {\n        read: \"Only the owner can read their completion records\",\n        write: \"Only the owner can create/update their completion records\",\n        validation: \"Timestamp must be within current day in user timezone\",\n    },\n    streaks: {\n        read: \"Owner can read their streaks, friends can read shared habit streaks\",\n        write: \"Only server-side functions can update streak calculations\",\n        validation: \"All calculations must be server-side validated\",\n    },\n    analytics: {\n        read: \"Only the owner can read their analytics\",\n        write: \"Only server-side functions can update analytics\",\n        validation: \"All metrics must be server-side calculated\",\n    },\n} as const;\n"],"mappings":";;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,IAAA,GAAAD,OAAA;AACA,IAAAE,aAAA,GAAAF,OAAA;AAYO,IAAMG,wBAAwB,GAAAC,OAAA,CAAAD,wBAAA,GAAGE,MAAC,CAACC,MAAM,CAAY,UAACC,GAAG,EAAK;EACjE,OAAOA,GAAG,YAAYC,oBAAS;AACnC,CAAC,EAAE,+BAA+B,CAAC;AAG5B,IAAMC,wBAAwB,GAAAL,OAAA,CAAAK,wBAAA,GAAGJ,MAAC,CAACK,MAAM,CAAC;EAC7CC,OAAO,EAAEN,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EAC1BC,MAAM,EAAET,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EACzBE,WAAW,EAAEZ,wBAAwB;EACrCa,QAAQ,EAAEX,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EAC3BI,KAAK,EAAEZ,MAAC,CAACO,MAAM,CAAC,CAAC,CAACM,QAAQ,CAAC,CAAC;EAC5BC,UAAU,EAAEd,MAAC,CAACe,IAAI,CAAC,CAAC,MAAM,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAC;EAC9CC,SAAS,EAAElB;AACf,CAAC,CAAC;AAGK,IAAMmB,oBAAoB,GAAAlB,OAAA,CAAAkB,oBAAA,GAAGjB,MAAC,CAACK,MAAM,CAAC;EACzCC,OAAO,EAAEN,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EAC1BC,MAAM,EAAET,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EACzBU,aAAa,EAAElB,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACZ,GAAG,CAAC,CAAC,CAAC;EACtCa,UAAU,EAAErB,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACZ,GAAG,CAAC,CAAC,CAAC;EACnCc,kBAAkB,EAAEtB,MAAC,CAACO,MAAM,CAAC,CAAC,CAACgB,KAAK,CAAC,qBAAqB,CAAC;EAC3DC,eAAe,EAAExB,MAAC,CAACO,MAAM,CAAC,CAAC,CAACgB,KAAK,CAAC,qBAAqB,CAAC;EACxDE,gBAAgB,EAAEzB,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACZ,GAAG,CAAC,CAAC,CAAC;EACzCkB,WAAW,EAAE1B,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACZ,GAAG,CAAC,CAAC,CAAC;EACpCmB,UAAU,EAAE3B,MAAC,CAAC4B,KAAK,CACf5B,MAAC,CAACK,MAAM,CAAC;IACLwB,IAAI,EAAE7B,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACU,QAAQ,CAAC,CAAC;IACjCC,UAAU,EAAEjC,wBAAwB;IACpCkC,UAAU,EAAEhC,MAAC,CAACiC,OAAO,CAAC;EAC1B,CAAC,CACL,CAAC;EACDC,SAAS,EAAEpC;AACf,CAAC,CAAC;AAGK,IAAMqC,uBAAuB,GAAApC,OAAA,CAAAoC,uBAAA,GAAGnC,MAAC,CAACK,MAAM,CAAC;EAC5CC,OAAO,EAAEN,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EAC1BC,MAAM,EAAET,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EACzB4B,gBAAgB,EAAEpC,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAACZ,GAAG,CAAC,CAAC,CAAC;EACzC6B,oBAAoB,EAAErC,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACX,GAAG,CAAC,CAAC,CAAC,CAAC8B,GAAG,CAAC,GAAG,CAAC;EAChDC,mBAAmB,EAAEvC,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACX,GAAG,CAAC,CAAC,CAAC;EACtCgC,aAAa,EAAExC,MAAC,CAACO,MAAM,CAAC,CAAC,CAACC,GAAG,CAAC,CAAC,CAAC;EAChCiC,gBAAgB,EAAEzC,MAAC,CAACmB,MAAM,CAAC,CAAC,CAACX,GAAG,CAAC,CAAC,CAAC,CAAC8B,GAAG,CAAC,GAAG,CAAC;EAC5CI,WAAW,EAAE5C;AACjB,CAAC,CAAC;AAGK,IAAM6C,oBAAoB,GAAA5C,OAAA,CAAA4C,oBAAA,GAAG,SAAvBA,oBAAoBA,CAC7BlC,MAAc,EACdH,OAAe,EACfsC,SAAoB,EACX;EACT,OAAO,GAAGnC,MAAM,IAAIH,OAAO,IAAIsC,SAAS,CAACC,OAAO,EAAE;AACtD,CAAC;AAEM,IAAMC,gBAAgB,GAAA/C,OAAA,CAAA+C,gBAAA,GAAG,SAAnBA,gBAAgBA,CAAIrC,MAAc,EAAEH,OAAe,EAAa;EACzE,OAAO,GAAGG,MAAM,IAAIH,OAAO,EAAE;AACjC,CAAC;AAEM,IAAMyC,mBAAmB,GAAAhD,OAAA,CAAAgD,mBAAA,GAAG,SAAtBA,mBAAmBA,CAC5BtC,MAAc,EACdH,OAAe,EACN;EACT,OAAO,GAAGG,MAAM,IAAIH,OAAO,EAAE;AACjC,CAAC;AAGM,IAAM0C,iBAAiB,GAAAjD,OAAA,CAAAiD,iBAAA,GAAG,SAApBA,iBAAiBA,CAC1BC,UAA8C,EACrC;EACT,OAAOC,mCAAqB,CAACD,UAAU,CAAC;AAC5C,CAAC;AAGM,IAAME,8BAA8B,GAAApD,OAAA,CAAAoD,8BAAA,GAAG,SAAjCA,8BAA8BA,CAAIC,UAA2B,EAAK;EAC3E,OAAO;IACH9C,OAAO,EAAE8C,UAAU,CAAC9C,OAAO;IAC3BG,MAAM,EAAE2C,UAAU,CAAC3C,MAAM;IACzBC,WAAW,EAAE0C,UAAU,CAAC1C,WAAW;IACnCC,QAAQ,EAAEyC,UAAU,CAACzC,QAAQ;IAC7BC,KAAK,EAAEwC,UAAU,CAACxC,KAAK;IACvBE,UAAU,EAAEsC,UAAU,CAACtC,UAAU;IACjCE,SAAS,EAAEb,oBAAS,CAACkD,GAAG,CAAC;EAC7B,CAAC;AACL,CAAC;AAEM,IAAMC,8BAA8B,GAAAvD,OAAA,CAAAuD,8BAAA,GAAG,SAAjCA,8BAA8BA,CACvCC,EAAU,EACVC,IAAS,EACS;EAClB,OAAO;IACHD,EAAE,EAAFA,EAAE;IACFjD,OAAO,EAAEkD,IAAI,CAAClD,OAAO;IACrBG,MAAM,EAAE+C,IAAI,CAAC/C,MAAM;IACnBC,WAAW,EAAE8C,IAAI,CAAC9C,WAAW;IAC7BC,QAAQ,EAAE6C,IAAI,CAAC7C,QAAQ;IACvBC,KAAK,EAAE4C,IAAI,CAAC5C,KAAK;IACjBE,UAAU,EAAE0C,IAAI,CAAC1C;EACrB,CAAC;AACL,CAAC;AAEM,IAAM2C,0BAA0B,GAAA1D,OAAA,CAAA0D,0BAAA,GAAG,SAA7BA,0BAA0BA,CAAIC,MAAmB,EAAK;EAC/D,OAAO;IACHpD,OAAO,EAAEoD,MAAM,CAACpD,OAAO;IACvBG,MAAM,EAAEiD,MAAM,CAACjD,MAAM;IACrBS,aAAa,EAAEwC,MAAM,CAACxC,aAAa;IACnCG,UAAU,EAAEqC,MAAM,CAACrC,UAAU;IAC7BC,kBAAkB,EAAEoC,MAAM,CAACpC,kBAAkB;IAC7CE,eAAe,EAAEkC,MAAM,CAAClC,eAAe;IACvCC,gBAAgB,EAAEiC,MAAM,CAACjC,gBAAgB;IACzCC,WAAW,EAAEgC,MAAM,CAAChC,WAAW;IAC/BC,UAAU,EAAE+B,MAAM,CAAC/B,UAAU;IAC7BO,SAAS,EAAE/B,oBAAS,CAACkD,GAAG,CAAC;EAC7B,CAAC;AACL,CAAC;AAEM,IAAMM,0BAA0B,GAAA5D,OAAA,CAAA4D,0BAAA,GAAG,SAA7BA,0BAA0BA,CAAIH,IAAS,EAAkB;EAClE,OAAO;IACHlD,OAAO,EAAEkD,IAAI,CAAClD,OAAO;IACrBG,MAAM,EAAE+C,IAAI,CAAC/C,MAAM;IACnBS,aAAa,EAAEsC,IAAI,CAACtC,aAAa;IACjCG,UAAU,EAAEmC,IAAI,CAACnC,UAAU;IAC3BC,kBAAkB,EAAEkC,IAAI,CAAClC,kBAAkB;IAC3CE,eAAe,EAAEgC,IAAI,CAAChC,eAAe;IACrCC,gBAAgB,EAAE+B,IAAI,CAAC/B,gBAAgB;IACvCC,WAAW,EAAE8B,IAAI,CAAC9B,WAAW;IAC7BC,UAAU,EAAE6B,IAAI,CAAC7B,UAAU,IAAI;EACnC,CAAC;AACL,CAAC;AAEM,IAAMiC,6BAA6B,GAAA7D,OAAA,CAAA6D,6BAAA,GAAG,SAAhCA,6BAA6BA,CAAIC,SAAyB,EAAK;EACxE,OAAO;IACHvD,OAAO,EAAEuD,SAAS,CAACvD,OAAO;IAC1BG,MAAM,EAAEoD,SAAS,CAACpD,MAAM;IACxB2B,gBAAgB,EAAEyB,SAAS,CAACzB,gBAAgB;IAC5CC,oBAAoB,EAAEwB,SAAS,CAACxB,oBAAoB;IACpDE,mBAAmB,EAAEsB,SAAS,CAACtB,mBAAmB;IAClDC,aAAa,EAAEqB,SAAS,CAACrB,aAAa;IACtCC,gBAAgB,EAAEoB,SAAS,CAACpB,gBAAgB;IAC5CC,WAAW,EAAEmB,SAAS,CAACnB;EAC3B,CAAC;AACL,CAAC;AAEM,IAAMoB,6BAA6B,GAAA/D,OAAA,CAAA+D,6BAAA,GAAG,SAAhCA,6BAA6BA,CAAIN,IAAS,EAAqB;EACxE,OAAO;IACHlD,OAAO,EAAEkD,IAAI,CAAClD,OAAO;IACrBG,MAAM,EAAE+C,IAAI,CAAC/C,MAAM;IACnB2B,gBAAgB,EAAEoB,IAAI,CAACpB,gBAAgB;IACvCC,oBAAoB,EAAEmB,IAAI,CAACnB,oBAAoB;IAC/CE,mBAAmB,EAAEiB,IAAI,CAACjB,mBAAmB;IAC7CC,aAAa,EAAEgB,IAAI,CAAChB,aAAa;IACjCC,gBAAgB,EAAEe,IAAI,CAACf,gBAAgB;IACvCC,WAAW,EAAEc,IAAI,CAACd;EACtB,CAAC;AACL,CAAC;AAGM,IAAMqB,0BAA0B,GAAAhE,OAAA,CAAAgE,0BAAA,GAAG,SAA7BA,0BAA0BA,CAAIP,IAAS,EAAc;EAC9D,OAAOpD,wBAAwB,CAAC4D,SAAS,CAACR,IAAI,CAAC,CAACS,OAAO;AAC3D,CAAC;AAEM,IAAMC,sBAAsB,GAAAnE,OAAA,CAAAmE,sBAAA,GAAG,SAAzBA,sBAAsBA,CAAIV,IAAS,EAAc;EAC1D,OAAOvC,oBAAoB,CAAC+C,SAAS,CAACR,IAAI,CAAC,CAACS,OAAO;AACvD,CAAC;AAEM,IAAME,yBAAyB,GAAApE,OAAA,CAAAoE,yBAAA,GAAG,SAA5BA,yBAAyBA,CAAIX,IAAS,EAAc;EAC7D,OAAOrB,uBAAuB,CAAC6B,SAAS,CAACR,IAAI,CAAC,CAACS,OAAO;AAC1D,CAAC;AAGM,IAAMG,qBAAqB,GAAArE,OAAA,CAAAqE,qBAAA,GAAG,SAAxBA,qBAAqBA,CAC9B3D,MAAc,EACd4D,cAAsB,EACZ;EACV,OAAO5D,MAAM,KAAK4D,cAAc;AACpC,CAAC;AAEM,IAAMC,wBAAwB,GAAAvE,OAAA,CAAAuE,wBAAA,GAAG,SAA3BA,wBAAwBA,CACjC1B,SAAoB,EAEV;EAAA,IADV2B,WAAmB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,EAAE;EAExB,IAAMnB,GAAG,GAAGlD,oBAAS,CAACkD,GAAG,CAAC,CAAC;EAC3B,IAAMsB,MAAM,GAAGtB,GAAG,CAACuB,QAAQ,CAAC,CAAC,GAAGhC,SAAS,CAACgC,QAAQ,CAAC,CAAC;EACpD,IAAMC,SAAS,GAAGF,MAAM,IAAI,IAAI,GAAG,EAAE,GAAG,EAAE,CAAC;EAE3C,OAAOE,SAAS,IAAIN,WAAW;AACnC,CAAC;AAGM,IAAMO,4BAA4B,GAAA/E,OAAA,CAAA+E,4BAAA,GAAG;EACxCC,WAAW,EAAE;IACTC,IAAI,EAAE,kDAAkD;IACxDC,KAAK,EAAE,2DAA2D;IAClEC,UAAU,EAAE;EAChB,CAAC;EACDC,OAAO,EAAE;IACLH,IAAI,EAAE,qEAAqE;IAC3EC,KAAK,EAAE,2DAA2D;IAClEC,UAAU,EAAE;EAChB,CAAC;EACDrB,SAAS,EAAE;IACPmB,IAAI,EAAE,yCAAyC;IAC/CC,KAAK,EAAE,iDAAiD;IACxDC,UAAU,EAAE;EAChB;AACJ,CAAU","ignoreList":[]}