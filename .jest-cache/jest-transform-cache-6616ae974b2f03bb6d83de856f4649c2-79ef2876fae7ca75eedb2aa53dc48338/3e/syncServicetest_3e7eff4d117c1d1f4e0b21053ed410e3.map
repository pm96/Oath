{"version":3,"names":["_getJestObj","mock","getItem","jest","fn","setItem","removeItem","multiRemove","getAllKeys","db","isOnline","mockResolvedValue","retryWithBackoff","mockImplementation","_interopRequireDefault","require","default","_asyncToGenerator2","_asyncStorage","_firestore","_syncService","_require","describe","beforeEach","clearAllMocks","AsyncStorage","undefined","it","testData","test","value","syncService","cacheData","expect","toHaveBeenCalledWith","stringContaining","cachedData","data","timestamp","Timestamp","now","toMillis","version","checksum","JSON","stringify","result","getCachedData","toBeNull","operation","type","action","habitId","userId","queueOperation","operations","id","retryCount","Date","newSyncService","constructor","getInstance","Promise","resolve","setTimeout","status","getSyncStatus","toHaveProperty","callback","unsubscribe","onSyncStatusChange","objectContaining","any","Boolean","pendingOperations","Number","clearCache"],"sources":["syncService.test.ts"],"sourcesContent":["/**\n * Sync Service Tests\n *\n * Tests for data synchronization and offline support functionality\n * Requirements: 10.1, 10.2, 10.3, 10.4, 10.5\n */\n\nimport AsyncStorage from \"@react-native-async-storage/async-storage\";\nimport { Timestamp } from \"firebase/firestore\";\nimport { syncService } from \"../services/firebase/syncService\";\n\n// Mock AsyncStorage\njest.mock(\"@react-native-async-storage/async-storage\", () => ({\n    getItem: jest.fn(),\n    setItem: jest.fn(),\n    removeItem: jest.fn(),\n    multiRemove: jest.fn(),\n    getAllKeys: jest.fn(),\n}));\n\n// Mock Firebase\njest.mock(\"../firebaseConfig\", () => ({\n    db: {},\n}));\n\n// Mock error handling utilities\njest.mock(\"../utils/errorHandling\", () => ({\n    isOnline: jest.fn().mockResolvedValue(true),\n    retryWithBackoff: jest.fn().mockImplementation((fn) => fn()),\n}));\n\ndescribe(\"SyncService\", () => {\n    beforeEach(() => {\n        jest.clearAllMocks();\n        (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n        (AsyncStorage.setItem as jest.Mock).mockResolvedValue(undefined);\n        (AsyncStorage.removeItem as jest.Mock).mockResolvedValue(undefined);\n        (AsyncStorage.multiRemove as jest.Mock).mockResolvedValue(undefined);\n        (AsyncStorage.getAllKeys as jest.Mock).mockResolvedValue([]);\n    });\n\n    describe(\"Cache Management\", () => {\n        it(\"should cache data with integrity verification\", async () => {\n            const testData = { test: \"data\", value: 123 };\n\n            await syncService.cacheData(\"test_key\", testData);\n\n            expect(AsyncStorage.setItem).toHaveBeenCalledWith(\n                \"test_key\",\n                expect.stringContaining('\"data\":{\"test\":\"data\",\"value\":123}'),\n            );\n        });\n\n        it(\"should retrieve cached data and verify integrity\", async () => {\n            const testData = { test: \"data\", value: 123 };\n            const cachedData = {\n                data: testData,\n                timestamp: Timestamp.now().toMillis(),\n                version: 1,\n                checksum: \"123456789\", // Mock checksum\n            };\n\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(\n                JSON.stringify(cachedData),\n            );\n\n            const result = await syncService.getCachedData(\"test_key\");\n\n            // Should return null due to checksum mismatch (integrity check)\n            expect(result).toBeNull();\n            expect(AsyncStorage.removeItem).toHaveBeenCalledWith(\"test_key\");\n        });\n\n        it(\"should return null for non-existent cache\", async () => {\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n\n            const result = await syncService.getCachedData(\"non_existent_key\");\n\n            expect(result).toBeNull();\n        });\n    });\n\n    describe(\"Operation Queuing\", () => {\n        it(\"should queue operations for offline sync\", async () => {\n            const operation = {\n                type: \"completion\" as const,\n                action: \"create\" as const,\n                data: { habitId: \"habit1\", userId: \"user1\" },\n                userId: \"user1\",\n                habitId: \"habit1\",\n            };\n\n            await syncService.queueOperation(operation);\n\n            expect(AsyncStorage.setItem).toHaveBeenCalledWith(\n                \"@pending_sync_operations\",\n                expect.stringContaining('\"type\":\"completion\"'),\n            );\n        });\n\n        it(\"should load pending operations from storage\", async () => {\n            const operations = [\n                {\n                    id: \"op1\",\n                    type: \"completion\",\n                    action: \"create\",\n                    data: {},\n                    userId: \"user1\",\n                    habitId: \"habit1\",\n                    retryCount: 0,\n                    timestamp: Date.now(),\n                },\n            ];\n\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(\n                JSON.stringify(operations),\n            );\n\n            // Create new instance to trigger loading\n            const newSyncService = (syncService as any).constructor.getInstance();\n\n            // Wait for async initialization to complete\n            await new Promise((resolve) => setTimeout(resolve, 100));\n\n            expect(AsyncStorage.getItem).toHaveBeenCalledWith(\n                \"@pending_sync_operations\",\n            );\n        });\n    });\n\n    describe(\"Sync Status\", () => {\n        it(\"should provide current sync status\", () => {\n            const status = syncService.getSyncStatus();\n\n            expect(status).toHaveProperty(\"isOnline\");\n            expect(status).toHaveProperty(\"lastSync\");\n            expect(status).toHaveProperty(\"pendingOperations\");\n            expect(status).toHaveProperty(\"syncInProgress\");\n        });\n\n        it(\"should allow subscribing to status changes\", () => {\n            const callback = jest.fn();\n\n            const unsubscribe = syncService.onSyncStatusChange(callback);\n\n            expect(callback).toHaveBeenCalledWith(\n                expect.objectContaining({\n                    isOnline: expect.any(Boolean),\n                    pendingOperations: expect.any(Number),\n                }),\n            );\n\n            unsubscribe();\n        });\n    });\n\n    describe(\"Cache Cleanup\", () => {\n        it(\"should clear all cached data\", async () => {\n            await syncService.clearCache();\n\n            expect(AsyncStorage.multiRemove).toHaveBeenCalledWith([\n                \"@habit_streaks_cache\",\n                \"@habit_completions_cache\",\n                \"@pending_sync_operations\",\n                \"@last_sync_timestamp\",\n            ]);\n        });\n    });\n});\n"],"mappings":"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","ignoreList":[]}