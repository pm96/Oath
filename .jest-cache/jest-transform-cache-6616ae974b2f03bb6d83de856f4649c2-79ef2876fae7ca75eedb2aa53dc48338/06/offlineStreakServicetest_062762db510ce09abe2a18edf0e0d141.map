{"version":3,"names":["_getJestObj","mock","getItem","jest","fn","setItem","removeItem","getAllKeys","multiRemove","StreakService","mockImplementation","recordCompletion","calculateStreak","useStreakFreeze","getHabitCalendar","getHabitStreak","syncService","queueOperation","isOnline","_interopRequireDefault","require","default","_asyncToGenerator2","_asyncStorage","_firestore","_offlineStreakService","_require2","_require","describe","beforeEach","clearAllMocks","AsyncStorage","mockResolvedValue","undefined","it","completion","habitId","userId","completedAt","Timestamp","now","timezone","difficulty","mockResult","Object","assign","id","mockStreakService","offlineStreakService","streakService","result","expect","toHaveBeenCalledWith","toEqual","toHaveBeenCalled","toMatch","mockRejectedValue","Error","mockStreak","currentStreak","bestStreak","lastCompletionDate","streakStartDate","freezesAvailable","freezesUsed","milestones","cachedStreak","JSON","stringify","mockKeys","clearUserCache","mockData","data","timestamp","Date","stats","getCacheStats","totalItems","toBe","totalSize","toBeGreaterThan","lastUpdated","toBeInstanceOf","Number"],"sources":["offlineStreakService.test.ts"],"sourcesContent":["/**\n * Offline Streak Service Tests\n *\n * Tests for offline-aware streak operations\n * Requirements: 10.3, 10.4\n */\n\nimport AsyncStorage from \"@react-native-async-storage/async-storage\";\nimport { Timestamp } from \"firebase/firestore\";\nimport { offlineStreakService } from \"../services/firebase/offlineStreakService\";\nimport { HabitCompletion, HabitStreak } from \"../types/habit-streaks\";\n\n// Mock AsyncStorage\njest.mock(\"@react-native-async-storage/async-storage\", () => ({\n    getItem: jest.fn(),\n    setItem: jest.fn(),\n    removeItem: jest.fn(),\n    getAllKeys: jest.fn(),\n    multiRemove: jest.fn(),\n}));\n\n// Mock the underlying StreakService\njest.mock(\"../services/firebase/streakService\", () => ({\n    StreakService: jest.fn().mockImplementation(() => ({\n        recordCompletion: jest.fn(),\n        calculateStreak: jest.fn(),\n        useStreakFreeze: jest.fn(),\n        getHabitCalendar: jest.fn(),\n        getHabitStreak: jest.fn(),\n    })),\n}));\n\n// Mock sync service\njest.mock(\"../services/firebase/syncService\", () => ({\n    syncService: {\n        queueOperation: jest.fn(),\n    },\n}));\n\n// Mock error handling utilities\njest.mock(\"../utils/errorHandling\", () => ({\n    isOnline: jest.fn(),\n}));\n\nconst { isOnline } = require(\"../utils/errorHandling\");\n\ndescribe(\"OfflineStreakService\", () => {\n    beforeEach(() => {\n        jest.clearAllMocks();\n        (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n        (AsyncStorage.setItem as jest.Mock).mockResolvedValue(undefined);\n        (AsyncStorage.getAllKeys as jest.Mock).mockResolvedValue([]);\n        (AsyncStorage.multiRemove as jest.Mock).mockResolvedValue(undefined);\n    });\n\n    describe(\"Completion Recording\", () => {\n        it(\"should record completion online when connected\", async () => {\n            isOnline.mockResolvedValue(true);\n\n            const completion = {\n                habitId: \"habit1\",\n                userId: \"user1\",\n                completedAt: Timestamp.now(),\n                timezone: \"UTC\",\n                difficulty: \"medium\" as const,\n            };\n\n            const mockResult: HabitCompletion = {\n                ...completion,\n                id: \"completion1\",\n            };\n\n            // Mock successful online operation\n            const mockStreakService = (offlineStreakService as any).streakService;\n            mockStreakService.recordCompletion.mockResolvedValue(mockResult);\n\n            const result = await offlineStreakService.recordCompletion(completion);\n\n            expect(mockStreakService.recordCompletion).toHaveBeenCalledWith(\n                completion,\n            );\n            expect(result).toEqual(mockResult);\n            expect(AsyncStorage.setItem).toHaveBeenCalled(); // Should cache the result\n        });\n\n        it(\"should record completion offline when disconnected\", async () => {\n            isOnline.mockResolvedValue(false);\n\n            const completion = {\n                habitId: \"habit1\",\n                userId: \"user1\",\n                completedAt: Timestamp.now(),\n                timezone: \"UTC\",\n                difficulty: \"medium\" as const,\n            };\n\n            const result = await offlineStreakService.recordCompletion(completion);\n\n            expect(result.id).toMatch(/^offline_/);\n            expect(AsyncStorage.setItem).toHaveBeenCalled(); // Should cache offline completion\n        });\n\n        it(\"should fallback to offline mode when online operation fails\", async () => {\n            isOnline.mockResolvedValue(true);\n\n            const completion = {\n                habitId: \"habit1\",\n                userId: \"user1\",\n                completedAt: Timestamp.now(),\n                timezone: \"UTC\",\n                difficulty: \"medium\" as const,\n            };\n\n            // Mock failed online operation\n            const mockStreakService = (offlineStreakService as any).streakService;\n            mockStreakService.recordCompletion.mockRejectedValue(\n                new Error(\"Network error\"),\n            );\n\n            const result = await offlineStreakService.recordCompletion(completion);\n\n            expect(result.id).toMatch(/^offline_/);\n            expect(AsyncStorage.setItem).toHaveBeenCalled();\n        });\n    });\n\n    describe(\"Streak Calculation\", () => {\n        it(\"should calculate streak online when connected\", async () => {\n            isOnline.mockResolvedValue(true);\n\n            const mockStreak: HabitStreak = {\n                habitId: \"habit1\",\n                userId: \"user1\",\n                currentStreak: 5,\n                bestStreak: 10,\n                lastCompletionDate: \"2024-01-15\",\n                streakStartDate: \"2024-01-11\",\n                freezesAvailable: 1,\n                freezesUsed: 0,\n                milestones: [],\n            };\n\n            const mockStreakService = (offlineStreakService as any).streakService;\n            mockStreakService.calculateStreak.mockResolvedValue(mockStreak);\n\n            const result = await offlineStreakService.calculateStreak(\n                \"habit1\",\n                \"user1\",\n            );\n\n            expect(mockStreakService.calculateStreak).toHaveBeenCalledWith(\n                \"habit1\",\n                \"user1\",\n            );\n            expect(result).toEqual(mockStreak);\n            expect(AsyncStorage.setItem).toHaveBeenCalled(); // Should cache the result\n        });\n\n        it(\"should return cached streak when offline\", async () => {\n            isOnline.mockResolvedValue(false);\n\n            const cachedStreak = {\n                habitId: \"habit1\",\n                userId: \"user1\",\n                currentStreak: 3,\n                bestStreak: 8,\n                lastCompletionDate: \"2024-01-13\",\n                streakStartDate: \"2024-01-11\",\n                freezesAvailable: 0,\n                freezesUsed: 1,\n                milestones: [],\n            };\n\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(\n                JSON.stringify(cachedStreak),\n            );\n\n            const result = await offlineStreakService.calculateStreak(\n                \"habit1\",\n                \"user1\",\n            );\n\n            expect(result).toEqual(cachedStreak);\n        });\n\n        it(\"should return default streak when no cache available\", async () => {\n            isOnline.mockResolvedValue(false);\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n\n            const result = await offlineStreakService.calculateStreak(\n                \"habit1\",\n                \"user1\",\n            );\n\n            expect(result).toEqual({\n                habitId: \"habit1\",\n                userId: \"user1\",\n                currentStreak: 0,\n                bestStreak: 0,\n                lastCompletionDate: \"\",\n                streakStartDate: \"\",\n                freezesAvailable: 0,\n                freezesUsed: 0,\n                milestones: [],\n            });\n        });\n    });\n\n    describe(\"Cache Management\", () => {\n        it(\"should clear user cache\", async () => {\n            const mockKeys = [\n                \"@offline_streak_streak_user1_habit1\",\n                \"@offline_streak_completion_comp1\",\n                \"@offline_streak_calendar_user1_habit1\",\n                \"@other_cache_key\",\n            ];\n\n            (AsyncStorage.getAllKeys as jest.Mock).mockResolvedValue(mockKeys);\n\n            await offlineStreakService.clearUserCache(\"user1\");\n\n            expect(AsyncStorage.multiRemove).toHaveBeenCalledWith([\n                \"@offline_streak_streak_user1_habit1\",\n                \"@offline_streak_calendar_user1_habit1\",\n            ]);\n        });\n\n        it(\"should get cache statistics\", async () => {\n            const mockKeys = [\n                \"@offline_streak_streak_user1_habit1\",\n                \"@offline_streak_completion_comp1\",\n            ];\n\n            const mockData = JSON.stringify({ data: \"test\", timestamp: Date.now() });\n\n            (AsyncStorage.getAllKeys as jest.Mock).mockResolvedValue(mockKeys);\n            (AsyncStorage.getItem as jest.Mock).mockResolvedValue(mockData);\n\n            const stats = await offlineStreakService.getCacheStats(\"user1\");\n\n            expect(stats.totalItems).toBe(2);\n            expect(stats.totalSize).toBeGreaterThan(0);\n            expect(stats.lastUpdated).toBeInstanceOf(Number);\n        });\n    });\n});\n"],"mappings":"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","ignoreList":[]}