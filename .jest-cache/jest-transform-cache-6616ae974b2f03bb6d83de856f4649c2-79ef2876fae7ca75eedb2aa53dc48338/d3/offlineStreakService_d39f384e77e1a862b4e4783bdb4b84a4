d13ca1a83d4719731963a7e03c94250e
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.offlineStreakService = exports.OfflineStreakService = void 0;
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _asyncStorage = _interopRequireDefault(require("@react-native-async-storage/async-storage"));
var _firestore = require("firebase/firestore");
var _errorHandling = require("../../utils/errorHandling");
var _streakService = require("./streakService");
var _syncService = require("./syncService");
var OfflineStreakService = exports.OfflineStreakService = function () {
  function OfflineStreakService() {
    (0, _classCallCheck2.default)(this, OfflineStreakService);
    this.streakService = new _streakService.StreakService();
  }
  return (0, _createClass2.default)(OfflineStreakService, [{
    key: "recordCompletion",
    value: (function () {
      var _recordCompletion = (0, _asyncToGenerator2.default)(function* (completion) {
        var online = yield (0, _errorHandling.isOnline)();
        if (online) {
          try {
            var result = yield this.streakService.recordCompletion(completion);
            yield this.cacheCompletion(result);
            return result;
          } catch (error) {
            console.warn("Online completion failed, falling back to offline mode:", error);
            return yield this.recordCompletionOffline(completion);
          }
        } else {
          return yield this.recordCompletionOffline(completion);
        }
      });
      function recordCompletion(_x) {
        return _recordCompletion.apply(this, arguments);
      }
      return recordCompletion;
    }())
  }, {
    key: "recordCompletionOffline",
    value: (function () {
      var _recordCompletionOffline = (0, _asyncToGenerator2.default)(function* (completion) {
        var tempId = `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        var offlineCompletion = Object.assign({}, completion, {
          id: tempId
        });
        yield this.cacheCompletion(offlineCompletion);
        yield _syncService.syncService.queueOperation({
          type: "completion",
          action: "create",
          data: completion,
          userId: completion.userId,
          habitId: completion.habitId
        });
        return offlineCompletion;
      });
      function recordCompletionOffline(_x2) {
        return _recordCompletionOffline.apply(this, arguments);
      }
      return recordCompletionOffline;
    }())
  }, {
    key: "calculateStreak",
    value: (function () {
      var _calculateStreak = (0, _asyncToGenerator2.default)(function* (habitId, userId) {
        var online = yield (0, _errorHandling.isOnline)();
        if (online) {
          try {
            var streak = yield this.streakService.calculateStreak(habitId, userId);
            yield this.cacheStreak(streak);
            return streak;
          } catch (error) {
            console.warn("Online streak calculation failed, using cached data:", error);
            return yield this.getStreakFromCache(habitId, userId);
          }
        } else {
          return yield this.getStreakFromCache(habitId, userId);
        }
      });
      function calculateStreak(_x3, _x4) {
        return _calculateStreak.apply(this, arguments);
      }
      return calculateStreak;
    }())
  }, {
    key: "getStreakFromCache",
    value: (function () {
      var _getStreakFromCache = (0, _asyncToGenerator2.default)(function* (habitId, userId) {
        var cacheKey = `${OfflineStreakService.CACHE_PREFIX}streak_${userId}_${habitId}`;
        try {
          var cachedData = yield _asyncStorage.default.getItem(cacheKey);
          if (cachedData) {
            var parsed = JSON.parse(cachedData);
            if (parsed.milestones) {
              parsed.milestones = parsed.milestones.map(function (m) {
                return Object.assign({}, m, {
                  achievedAt: _firestore.Timestamp.fromMillis(m.achievedAt)
                });
              });
            }
            return parsed;
          }
        } catch (error) {
          console.error("Failed to get streak from cache:", error);
        }
        return {
          habitId: habitId,
          userId: userId,
          currentStreak: 0,
          bestStreak: 0,
          lastCompletionDate: "",
          streakStartDate: "",
          freezesAvailable: 0,
          freezesUsed: 0,
          milestones: []
        };
      });
      function getStreakFromCache(_x5, _x6) {
        return _getStreakFromCache.apply(this, arguments);
      }
      return getStreakFromCache;
    }())
  }, {
    key: "useStreakFreeze",
    value: (function () {
      var _useStreakFreeze = (0, _asyncToGenerator2.default)(function* (habitId, userId, missedDate) {
        var online = yield (0, _errorHandling.isOnline)();
        if (online) {
          try {
            var result = yield this.streakService.useStreakFreeze(habitId, userId, missedDate);
            if (result) {
              var updatedStreak = yield this.streakService.getHabitStreak(habitId, userId);
              if (updatedStreak) {
                yield this.cacheStreak(updatedStreak);
              }
            }
            return result;
          } catch (error) {
            console.warn("Online freeze usage failed, queuing for later:", error);
            return yield this.useStreakFreezeOffline(habitId, userId, missedDate);
          }
        } else {
          return yield this.useStreakFreezeOffline(habitId, userId, missedDate);
        }
      });
      function useStreakFreeze(_x7, _x8, _x9) {
        return _useStreakFreeze.apply(this, arguments);
      }
      return useStreakFreeze;
    }())
  }, {
    key: "useStreakFreezeOffline",
    value: (function () {
      var _useStreakFreezeOffline = (0, _asyncToGenerator2.default)(function* (habitId, userId, missedDate) {
        var cachedStreak = yield this.getStreakFromCache(habitId, userId);
        if (cachedStreak.freezesAvailable <= 0) {
          return false;
        }
        var updatedStreak = Object.assign({}, cachedStreak, {
          freezesAvailable: cachedStreak.freezesAvailable - 1,
          freezesUsed: cachedStreak.freezesUsed + 1
        });
        yield this.cacheStreak(updatedStreak);
        yield _syncService.syncService.queueOperation({
          type: "streak",
          action: "update",
          data: updatedStreak,
          userId: userId,
          habitId: habitId
        });
        return true;
      });
      function useStreakFreezeOffline(_x0, _x1, _x10) {
        return _useStreakFreezeOffline.apply(this, arguments);
      }
      return useStreakFreezeOffline;
    }())
  }, {
    key: "getHabitCalendar",
    value: (function () {
      var _getHabitCalendar = (0, _asyncToGenerator2.default)(function* (habitId, userId, days, timezone) {
        var online = yield (0, _errorHandling.isOnline)();
        if (online) {
          try {
            var calendar = yield this.streakService.getHabitCalendar(habitId, userId, days, timezone);
            yield this.cacheCalendar(habitId, userId, calendar);
            return calendar;
          } catch (error) {
            console.warn("Online calendar fetch failed, using cached data:", error);
            return yield this.getCalendarFromCache(habitId, userId);
          }
        } else {
          return yield this.getCalendarFromCache(habitId, userId);
        }
      });
      function getHabitCalendar(_x11, _x12, _x13, _x14) {
        return _getHabitCalendar.apply(this, arguments);
      }
      return getHabitCalendar;
    }())
  }, {
    key: "cacheCompletion",
    value: (function () {
      var _cacheCompletion = (0, _asyncToGenerator2.default)(function* (completion) {
        var cacheKey = `${OfflineStreakService.CACHE_PREFIX}completion_${completion.id}`;
        try {
          var serialized = Object.assign({}, completion, {
            completedAt: completion.completedAt.toMillis()
          });
          yield _asyncStorage.default.setItem(cacheKey, JSON.stringify(serialized));
        } catch (error) {
          console.error("Failed to cache completion:", error);
        }
      });
      function cacheCompletion(_x15) {
        return _cacheCompletion.apply(this, arguments);
      }
      return cacheCompletion;
    }())
  }, {
    key: "cacheStreak",
    value: (function () {
      var _cacheStreak = (0, _asyncToGenerator2.default)(function* (streak) {
        var cacheKey = `${OfflineStreakService.CACHE_PREFIX}streak_${streak.userId}_${streak.habitId}`;
        try {
          var serialized = Object.assign({}, streak, {
            milestones: streak.milestones.map(function (m) {
              return Object.assign({}, m, {
                achievedAt: m.achievedAt.toMillis()
              });
            })
          });
          yield _asyncStorage.default.setItem(cacheKey, JSON.stringify(serialized));
        } catch (error) {
          console.error("Failed to cache streak:", error);
        }
      });
      function cacheStreak(_x16) {
        return _cacheStreak.apply(this, arguments);
      }
      return cacheStreak;
    }())
  }, {
    key: "cacheCalendar",
    value: (function () {
      var _cacheCalendar = (0, _asyncToGenerator2.default)(function* (habitId, userId, calendar) {
        var cacheKey = `${OfflineStreakService.CACHE_PREFIX}calendar_${userId}_${habitId}`;
        try {
          var serialized = {
            calendar: calendar,
            timestamp: Date.now()
          };
          yield _asyncStorage.default.setItem(cacheKey, JSON.stringify(serialized));
        } catch (error) {
          console.error("Failed to cache calendar:", error);
        }
      });
      function cacheCalendar(_x17, _x18, _x19) {
        return _cacheCalendar.apply(this, arguments);
      }
      return cacheCalendar;
    }())
  }, {
    key: "getCalendarFromCache",
    value: (function () {
      var _getCalendarFromCache = (0, _asyncToGenerator2.default)(function* (habitId, userId) {
        var cacheKey = `${OfflineStreakService.CACHE_PREFIX}calendar_${userId}_${habitId}`;
        try {
          var cachedData = yield _asyncStorage.default.getItem(cacheKey);
          if (cachedData) {
            var parsed = JSON.parse(cachedData);
            var cacheAge = Date.now() - parsed.timestamp;
            if (cacheAge < 24 * 60 * 60 * 1000) {
              return parsed.calendar;
            }
          }
        } catch (error) {
          console.error("Failed to get calendar from cache:", error);
        }
        return [];
      });
      function getCalendarFromCache(_x20, _x21) {
        return _getCalendarFromCache.apply(this, arguments);
      }
      return getCalendarFromCache;
    }())
  }, {
    key: "clearUserCache",
    value: (function () {
      var _clearUserCache = (0, _asyncToGenerator2.default)(function* (userId) {
        try {
          var allKeys = yield _asyncStorage.default.getAllKeys();
          var userKeys = allKeys.filter(function (key) {
            return key.startsWith(OfflineStreakService.CACHE_PREFIX) && key.includes(userId);
          });
          if (userKeys.length > 0) {
            yield _asyncStorage.default.multiRemove(userKeys);
          }
        } catch (error) {
          console.error("Failed to clear user cache:", error);
        }
      });
      function clearUserCache(_x22) {
        return _clearUserCache.apply(this, arguments);
      }
      return clearUserCache;
    }())
  }, {
    key: "getCacheStats",
    value: (function () {
      var _getCacheStats = (0, _asyncToGenerator2.default)(function* (userId) {
        try {
          var allKeys = yield _asyncStorage.default.getAllKeys();
          var userKeys = allKeys.filter(function (key) {
            return key.startsWith(OfflineStreakService.CACHE_PREFIX) && key.includes(userId);
          });
          var totalSize = 0;
          var lastUpdated = null;
          for (var key of userKeys) {
            var data = yield _asyncStorage.default.getItem(key);
            if (data) {
              totalSize += data.length;
              try {
                var parsed = JSON.parse(data);
                if (parsed.timestamp && (!lastUpdated || parsed.timestamp > lastUpdated)) {
                  lastUpdated = parsed.timestamp;
                }
              } catch (_unused) {}
            }
          }
          return {
            totalItems: userKeys.length,
            totalSize: totalSize,
            lastUpdated: lastUpdated
          };
        } catch (error) {
          console.error("Failed to get cache stats:", error);
          return {
            totalItems: 0,
            totalSize: 0,
            lastUpdated: null
          };
        }
      });
      function getCacheStats(_x23) {
        return _getCacheStats.apply(this, arguments);
      }
      return getCacheStats;
    }())
  }]);
}();
OfflineStreakService.CACHE_PREFIX = "@offline_streak_";
var offlineStreakService = exports.offlineStreakService = new OfflineStreakService();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXN5bmNTdG9yYWdlIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZmlyZXN0b3JlIiwiX2Vycm9ySGFuZGxpbmciLCJfc3RyZWFrU2VydmljZSIsIl9zeW5jU2VydmljZSIsIk9mZmxpbmVTdHJlYWtTZXJ2aWNlIiwiZXhwb3J0cyIsIl9jbGFzc0NhbGxDaGVjazIiLCJkZWZhdWx0Iiwic3RyZWFrU2VydmljZSIsIlN0cmVha1NlcnZpY2UiLCJfY3JlYXRlQ2xhc3MyIiwia2V5IiwidmFsdWUiLCJfcmVjb3JkQ29tcGxldGlvbiIsIl9hc3luY1RvR2VuZXJhdG9yMiIsImNvbXBsZXRpb24iLCJvbmxpbmUiLCJpc09ubGluZSIsInJlc3VsdCIsInJlY29yZENvbXBsZXRpb24iLCJjYWNoZUNvbXBsZXRpb24iLCJlcnJvciIsImNvbnNvbGUiLCJ3YXJuIiwicmVjb3JkQ29tcGxldGlvbk9mZmxpbmUiLCJfeCIsImFwcGx5IiwiYXJndW1lbnRzIiwiX3JlY29yZENvbXBsZXRpb25PZmZsaW5lIiwidGVtcElkIiwiRGF0ZSIsIm5vdyIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0ciIsIm9mZmxpbmVDb21wbGV0aW9uIiwiT2JqZWN0IiwiYXNzaWduIiwiaWQiLCJzeW5jU2VydmljZSIsInF1ZXVlT3BlcmF0aW9uIiwidHlwZSIsImFjdGlvbiIsImRhdGEiLCJ1c2VySWQiLCJoYWJpdElkIiwiX3gyIiwiX2NhbGN1bGF0ZVN0cmVhayIsInN0cmVhayIsImNhbGN1bGF0ZVN0cmVhayIsImNhY2hlU3RyZWFrIiwiZ2V0U3RyZWFrRnJvbUNhY2hlIiwiX3gzIiwiX3g0IiwiX2dldFN0cmVha0Zyb21DYWNoZSIsImNhY2hlS2V5IiwiQ0FDSEVfUFJFRklYIiwiY2FjaGVkRGF0YSIsIkFzeW5jU3RvcmFnZSIsImdldEl0ZW0iLCJwYXJzZWQiLCJKU09OIiwicGFyc2UiLCJtaWxlc3RvbmVzIiwibWFwIiwibSIsImFjaGlldmVkQXQiLCJUaW1lc3RhbXAiLCJmcm9tTWlsbGlzIiwiY3VycmVudFN0cmVhayIsImJlc3RTdHJlYWsiLCJsYXN0Q29tcGxldGlvbkRhdGUiLCJzdHJlYWtTdGFydERhdGUiLCJmcmVlemVzQXZhaWxhYmxlIiwiZnJlZXplc1VzZWQiLCJfeDUiLCJfeDYiLCJfdXNlU3RyZWFrRnJlZXplIiwibWlzc2VkRGF0ZSIsInVzZVN0cmVha0ZyZWV6ZSIsInVwZGF0ZWRTdHJlYWsiLCJnZXRIYWJpdFN0cmVhayIsInVzZVN0cmVha0ZyZWV6ZU9mZmxpbmUiLCJfeDciLCJfeDgiLCJfeDkiLCJfdXNlU3RyZWFrRnJlZXplT2ZmbGluZSIsImNhY2hlZFN0cmVhayIsIl94MCIsIl94MSIsIl94MTAiLCJfZ2V0SGFiaXRDYWxlbmRhciIsImRheXMiLCJ0aW1lem9uZSIsImNhbGVuZGFyIiwiZ2V0SGFiaXRDYWxlbmRhciIsImNhY2hlQ2FsZW5kYXIiLCJnZXRDYWxlbmRhckZyb21DYWNoZSIsIl94MTEiLCJfeDEyIiwiX3gxMyIsIl94MTQiLCJfY2FjaGVDb21wbGV0aW9uIiwic2VyaWFsaXplZCIsImNvbXBsZXRlZEF0IiwidG9NaWxsaXMiLCJzZXRJdGVtIiwic3RyaW5naWZ5IiwiX3gxNSIsIl9jYWNoZVN0cmVhayIsIl94MTYiLCJfY2FjaGVDYWxlbmRhciIsInRpbWVzdGFtcCIsIl94MTciLCJfeDE4IiwiX3gxOSIsIl9nZXRDYWxlbmRhckZyb21DYWNoZSIsImNhY2hlQWdlIiwiX3gyMCIsIl94MjEiLCJfY2xlYXJVc2VyQ2FjaGUiLCJhbGxLZXlzIiwiZ2V0QWxsS2V5cyIsInVzZXJLZXlzIiwiZmlsdGVyIiwic3RhcnRzV2l0aCIsImluY2x1ZGVzIiwibGVuZ3RoIiwibXVsdGlSZW1vdmUiLCJjbGVhclVzZXJDYWNoZSIsIl94MjIiLCJfZ2V0Q2FjaGVTdGF0cyIsInRvdGFsU2l6ZSIsImxhc3RVcGRhdGVkIiwiX3VudXNlZCIsInRvdGFsSXRlbXMiLCJnZXRDYWNoZVN0YXRzIiwiX3gyMyIsIm9mZmxpbmVTdHJlYWtTZXJ2aWNlIl0sInNvdXJjZXMiOlsib2ZmbGluZVN0cmVha1NlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPZmZsaW5lLUF3YXJlIFN0cmVhayBTZXJ2aWNlXG4gKlxuICogV3JhcHMgdGhlIGV4aXN0aW5nIFN0cmVha1NlcnZpY2Ugd2l0aCBvZmZsaW5lIHN1cHBvcnQgYW5kIGNhY2hpbmdcbiAqIFJlcXVpcmVtZW50czogMTAuMSwgMTAuMiwgMTAuMywgMTAuNCwgMTAuNVxuICovXG5cbmltcG9ydCBBc3luY1N0b3JhZ2UgZnJvbSBcIkByZWFjdC1uYXRpdmUtYXN5bmMtc3RvcmFnZS9hc3luYy1zdG9yYWdlXCI7XG5pbXBvcnQgeyBUaW1lc3RhbXAgfSBmcm9tIFwiZmlyZWJhc2UvZmlyZXN0b3JlXCI7XG5pbXBvcnQgeyBIYWJpdENvbXBsZXRpb24sIEhhYml0U3RyZWFrIH0gZnJvbSBcIi4uLy4uL3R5cGVzL2hhYml0LXN0cmVha3NcIjtcbmltcG9ydCB7IGlzT25saW5lIH0gZnJvbSBcIi4uLy4uL3V0aWxzL2Vycm9ySGFuZGxpbmdcIjtcbmltcG9ydCB7IFN0cmVha1NlcnZpY2UgfSBmcm9tIFwiLi9zdHJlYWtTZXJ2aWNlXCI7XG5pbXBvcnQgeyBzeW5jU2VydmljZSB9IGZyb20gXCIuL3N5bmNTZXJ2aWNlXCI7XG5cbi8qKlxuICogT2ZmbGluZS1hd2FyZSB3cmFwcGVyIGZvciBTdHJlYWtTZXJ2aWNlXG4gKi9cbmV4cG9ydCBjbGFzcyBPZmZsaW5lU3RyZWFrU2VydmljZSB7XG4gICAgcHJpdmF0ZSBzdHJlYWtTZXJ2aWNlOiBTdHJlYWtTZXJ2aWNlO1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IENBQ0hFX1BSRUZJWCA9IFwiQG9mZmxpbmVfc3RyZWFrX1wiO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuc3RyZWFrU2VydmljZSA9IG5ldyBTdHJlYWtTZXJ2aWNlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVjb3JkIGNvbXBsZXRpb24gd2l0aCBvZmZsaW5lIHN1cHBvcnRcbiAgICAgKiBSZXF1aXJlbWVudHM6IDEwLjRcbiAgICAgKi9cbiAgICBhc3luYyByZWNvcmRDb21wbGV0aW9uKFxuICAgICAgICBjb21wbGV0aW9uOiBPbWl0PEhhYml0Q29tcGxldGlvbiwgXCJpZFwiPixcbiAgICApOiBQcm9taXNlPEhhYml0Q29tcGxldGlvbj4ge1xuICAgICAgICBjb25zdCBvbmxpbmUgPSBhd2FpdCBpc09ubGluZSgpO1xuXG4gICAgICAgIGlmIChvbmxpbmUpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8gVHJ5IHRvIHJlY29yZCBvbmxpbmUgZmlyc3RcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnN0cmVha1NlcnZpY2UucmVjb3JkQ29tcGxldGlvbihjb21wbGV0aW9uKTtcblxuICAgICAgICAgICAgICAgIC8vIENhY2hlIHRoZSBzdWNjZXNzZnVsIHJlc3VsdFxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGVDb21wbGV0aW9uKHJlc3VsdCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAgICAgICAgIFwiT25saW5lIGNvbXBsZXRpb24gZmFpbGVkLCBmYWxsaW5nIGJhY2sgdG8gb2ZmbGluZSBtb2RlOlwiLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlY29yZENvbXBsZXRpb25PZmZsaW5lKGNvbXBsZXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVjb3JkQ29tcGxldGlvbk9mZmxpbmUoY29tcGxldGlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWNvcmQgY29tcGxldGlvbiBpbiBvZmZsaW5lIG1vZGVcbiAgICAgKiBSZXF1aXJlbWVudHM6IDEwLjRcbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIHJlY29yZENvbXBsZXRpb25PZmZsaW5lKFxuICAgICAgICBjb21wbGV0aW9uOiBPbWl0PEhhYml0Q29tcGxldGlvbiwgXCJpZFwiPixcbiAgICApOiBQcm9taXNlPEhhYml0Q29tcGxldGlvbj4ge1xuICAgICAgICAvLyBHZW5lcmF0ZSB0ZW1wb3JhcnkgSUQgZm9yIG9mZmxpbmUgY29tcGxldGlvblxuICAgICAgICBjb25zdCB0ZW1wSWQgPSBgb2ZmbGluZV8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG5cbiAgICAgICAgY29uc3Qgb2ZmbGluZUNvbXBsZXRpb246IEhhYml0Q29tcGxldGlvbiA9IHtcbiAgICAgICAgICAgIC4uLmNvbXBsZXRpb24sXG4gICAgICAgICAgICBpZDogdGVtcElkLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIENhY2hlIHRoZSBjb21wbGV0aW9uIGxvY2FsbHlcbiAgICAgICAgYXdhaXQgdGhpcy5jYWNoZUNvbXBsZXRpb24ob2ZmbGluZUNvbXBsZXRpb24pO1xuXG4gICAgICAgIC8vIFF1ZXVlIGZvciBzeW5jIHdoZW4gb25saW5lXG4gICAgICAgIGF3YWl0IHN5bmNTZXJ2aWNlLnF1ZXVlT3BlcmF0aW9uKHtcbiAgICAgICAgICAgIHR5cGU6IFwiY29tcGxldGlvblwiLFxuICAgICAgICAgICAgYWN0aW9uOiBcImNyZWF0ZVwiLFxuICAgICAgICAgICAgZGF0YTogY29tcGxldGlvbixcbiAgICAgICAgICAgIHVzZXJJZDogY29tcGxldGlvbi51c2VySWQsXG4gICAgICAgICAgICBoYWJpdElkOiBjb21wbGV0aW9uLmhhYml0SWQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBvZmZsaW5lQ29tcGxldGlvbjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgc3RyZWFrIHdpdGggb2ZmbGluZSBzdXBwb3J0XG4gICAgICogUmVxdWlyZW1lbnRzOiAxMC4zLCAxMC40XG4gICAgICovXG4gICAgYXN5bmMgY2FsY3VsYXRlU3RyZWFrKGhhYml0SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPEhhYml0U3RyZWFrPiB7XG4gICAgICAgIGNvbnN0IG9ubGluZSA9IGF3YWl0IGlzT25saW5lKCk7XG5cbiAgICAgICAgaWYgKG9ubGluZSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZ2V0IGZyZXNoIGRhdGEgZnJvbSBzZXJ2ZXJcbiAgICAgICAgICAgICAgICBjb25zdCBzdHJlYWsgPSBhd2FpdCB0aGlzLnN0cmVha1NlcnZpY2UuY2FsY3VsYXRlU3RyZWFrKFxuICAgICAgICAgICAgICAgICAgICBoYWJpdElkLFxuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNhY2hlU3RyZWFrKHN0cmVhayk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyZWFrO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAgICAgICAgIFwiT25saW5lIHN0cmVhayBjYWxjdWxhdGlvbiBmYWlsZWQsIHVzaW5nIGNhY2hlZCBkYXRhOlwiLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFN0cmVha0Zyb21DYWNoZShoYWJpdElkLCB1c2VySWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0U3RyZWFrRnJvbUNhY2hlKGhhYml0SWQsIHVzZXJJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgc3RyZWFrIGZyb20gY2FjaGUgd2l0aCBmYWxsYmFja1xuICAgICAqIFJlcXVpcmVtZW50czogMTAuM1xuICAgICAqL1xuICAgIHByaXZhdGUgYXN5bmMgZ2V0U3RyZWFrRnJvbUNhY2hlKFxuICAgICAgICBoYWJpdElkOiBzdHJpbmcsXG4gICAgICAgIHVzZXJJZDogc3RyaW5nLFxuICAgICk6IFByb21pc2U8SGFiaXRTdHJlYWs+IHtcbiAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBgJHtPZmZsaW5lU3RyZWFrU2VydmljZS5DQUNIRV9QUkVGSVh9c3RyZWFrXyR7dXNlcklkfV8ke2hhYml0SWR9YDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVkRGF0YSA9IGF3YWl0IEFzeW5jU3RvcmFnZS5nZXRJdGVtKGNhY2hlS2V5KTtcbiAgICAgICAgICAgIGlmIChjYWNoZWREYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShjYWNoZWREYXRhKTtcblxuICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdGltZXN0YW1wIGZpZWxkcyBiYWNrIHRvIFRpbWVzdGFtcCBvYmplY3RzXG4gICAgICAgICAgICAgICAgaWYgKHBhcnNlZC5taWxlc3RvbmVzKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZC5taWxlc3RvbmVzID0gcGFyc2VkLm1pbGVzdG9uZXMubWFwKChtOiBhbnkpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5tLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWNoaWV2ZWRBdDogVGltZXN0YW1wLmZyb21NaWxsaXMobS5hY2hpZXZlZEF0KSxcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGdldCBzdHJlYWsgZnJvbSBjYWNoZTpcIiwgZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmV0dXJuIGRlZmF1bHQgc3RyZWFrIGlmIG5vIGNhY2hlIGF2YWlsYWJsZVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaGFiaXRJZCxcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGN1cnJlbnRTdHJlYWs6IDAsXG4gICAgICAgICAgICBiZXN0U3RyZWFrOiAwLFxuICAgICAgICAgICAgbGFzdENvbXBsZXRpb25EYXRlOiBcIlwiLFxuICAgICAgICAgICAgc3RyZWFrU3RhcnREYXRlOiBcIlwiLFxuICAgICAgICAgICAgZnJlZXplc0F2YWlsYWJsZTogMCxcbiAgICAgICAgICAgIGZyZWV6ZXNVc2VkOiAwLFxuICAgICAgICAgICAgbWlsZXN0b25lczogW10sXG4gICAgICAgIH07XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFVzZSBzdHJlYWsgZnJlZXplIHdpdGggb2ZmbGluZSBzdXBwb3J0XG4gICAgICogUmVxdWlyZW1lbnRzOiAxMC40XG4gICAgICovXG4gICAgYXN5bmMgdXNlU3RyZWFrRnJlZXplKFxuICAgICAgICBoYWJpdElkOiBzdHJpbmcsXG4gICAgICAgIHVzZXJJZDogc3RyaW5nLFxuICAgICAgICBtaXNzZWREYXRlOiBzdHJpbmcsXG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IG9ubGluZSA9IGF3YWl0IGlzT25saW5lKCk7XG5cbiAgICAgICAgaWYgKG9ubGluZSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnN0cmVha1NlcnZpY2UudXNlU3RyZWFrRnJlZXplKFxuICAgICAgICAgICAgICAgICAgICBoYWJpdElkLFxuICAgICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIG1pc3NlZERhdGUsXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjYWNoZWQgc3RyZWFrIGlmIHN1Y2Nlc3NmdWxcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWRTdHJlYWsgPSBhd2FpdCB0aGlzLnN0cmVha1NlcnZpY2UuZ2V0SGFiaXRTdHJlYWsoXG4gICAgICAgICAgICAgICAgICAgICAgICBoYWJpdElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlZFN0cmVhaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jYWNoZVN0cmVhayh1cGRhdGVkU3RyZWFrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcIk9ubGluZSBmcmVlemUgdXNhZ2UgZmFpbGVkLCBxdWV1aW5nIGZvciBsYXRlcjpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVzZVN0cmVha0ZyZWV6ZU9mZmxpbmUoaGFiaXRJZCwgdXNlcklkLCBtaXNzZWREYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVzZVN0cmVha0ZyZWV6ZU9mZmxpbmUoaGFiaXRJZCwgdXNlcklkLCBtaXNzZWREYXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVzZSBzdHJlYWsgZnJlZXplIGluIG9mZmxpbmUgbW9kZVxuICAgICAqIFJlcXVpcmVtZW50czogMTAuNFxuICAgICAqL1xuICAgIHByaXZhdGUgYXN5bmMgdXNlU3RyZWFrRnJlZXplT2ZmbGluZShcbiAgICAgICAgaGFiaXRJZDogc3RyaW5nLFxuICAgICAgICB1c2VySWQ6IHN0cmluZyxcbiAgICAgICAgbWlzc2VkRGF0ZTogc3RyaW5nLFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICAvLyBHZXQgY2FjaGVkIHN0cmVhayB0byBjaGVjayBmcmVlemUgYXZhaWxhYmlsaXR5XG4gICAgICAgIGNvbnN0IGNhY2hlZFN0cmVhayA9IGF3YWl0IHRoaXMuZ2V0U3RyZWFrRnJvbUNhY2hlKGhhYml0SWQsIHVzZXJJZCk7XG5cbiAgICAgICAgaWYgKGNhY2hlZFN0cmVhay5mcmVlemVzQXZhaWxhYmxlIDw9IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVwZGF0ZSBjYWNoZWQgc3RyZWFrIG9wdGltaXN0aWNhbGx5XG4gICAgICAgIGNvbnN0IHVwZGF0ZWRTdHJlYWs6IEhhYml0U3RyZWFrID0ge1xuICAgICAgICAgICAgLi4uY2FjaGVkU3RyZWFrLFxuICAgICAgICAgICAgZnJlZXplc0F2YWlsYWJsZTogY2FjaGVkU3RyZWFrLmZyZWV6ZXNBdmFpbGFibGUgLSAxLFxuICAgICAgICAgICAgZnJlZXplc1VzZWQ6IGNhY2hlZFN0cmVhay5mcmVlemVzVXNlZCArIDEsXG4gICAgICAgIH07XG5cbiAgICAgICAgYXdhaXQgdGhpcy5jYWNoZVN0cmVhayh1cGRhdGVkU3RyZWFrKTtcblxuICAgICAgICAvLyBRdWV1ZSB0aGUgb3BlcmF0aW9uIGZvciBzeW5jXG4gICAgICAgIGF3YWl0IHN5bmNTZXJ2aWNlLnF1ZXVlT3BlcmF0aW9uKHtcbiAgICAgICAgICAgIHR5cGU6IFwic3RyZWFrXCIsXG4gICAgICAgICAgICBhY3Rpb246IFwidXBkYXRlXCIsXG4gICAgICAgICAgICBkYXRhOiB1cGRhdGVkU3RyZWFrLFxuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgaGFiaXRJZCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGhhYml0IGNhbGVuZGFyIHdpdGggb2ZmbGluZSBzdXBwb3J0XG4gICAgICogUmVxdWlyZW1lbnRzOiAxMC4zLCAxMC40XG4gICAgICovXG4gICAgYXN5bmMgZ2V0SGFiaXRDYWxlbmRhcihcbiAgICAgICAgaGFiaXRJZDogc3RyaW5nLFxuICAgICAgICB1c2VySWQ6IHN0cmluZyxcbiAgICAgICAgZGF5czogbnVtYmVyLFxuICAgICAgICB0aW1lem9uZTogc3RyaW5nLFxuICAgICkge1xuICAgICAgICBjb25zdCBvbmxpbmUgPSBhd2FpdCBpc09ubGluZSgpO1xuXG4gICAgICAgIGlmIChvbmxpbmUpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FsZW5kYXIgPSBhd2FpdCB0aGlzLnN0cmVha1NlcnZpY2UuZ2V0SGFiaXRDYWxlbmRhcihcbiAgICAgICAgICAgICAgICAgICAgaGFiaXRJZCxcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgICBkYXlzLFxuICAgICAgICAgICAgICAgICAgICB0aW1lem9uZSxcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgLy8gQ2FjaGUgY2FsZW5kYXIgZGF0YVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY2FjaGVDYWxlbmRhcihoYWJpdElkLCB1c2VySWQsIGNhbGVuZGFyKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxlbmRhcjtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiT25saW5lIGNhbGVuZGFyIGZldGNoIGZhaWxlZCwgdXNpbmcgY2FjaGVkIGRhdGE6XCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRDYWxlbmRhckZyb21DYWNoZShoYWJpdElkLCB1c2VySWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Q2FsZW5kYXJGcm9tQ2FjaGUoaGFiaXRJZCwgdXNlcklkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhY2hlIGNvbXBsZXRpb24gZGF0YVxuICAgICAqL1xuICAgIHByaXZhdGUgYXN5bmMgY2FjaGVDb21wbGV0aW9uKGNvbXBsZXRpb246IEhhYml0Q29tcGxldGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBjYWNoZUtleSA9IGAke09mZmxpbmVTdHJlYWtTZXJ2aWNlLkNBQ0hFX1BSRUZJWH1jb21wbGV0aW9uXyR7Y29tcGxldGlvbi5pZH1gO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBTZXJpYWxpemUgdGltZXN0YW1wIGZvciBzdG9yYWdlXG4gICAgICAgICAgICBjb25zdCBzZXJpYWxpemVkID0ge1xuICAgICAgICAgICAgICAgIC4uLmNvbXBsZXRpb24sXG4gICAgICAgICAgICAgICAgY29tcGxldGVkQXQ6IGNvbXBsZXRpb24uY29tcGxldGVkQXQudG9NaWxsaXMoKSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGF3YWl0IEFzeW5jU3RvcmFnZS5zZXRJdGVtKGNhY2hlS2V5LCBKU09OLnN0cmluZ2lmeShzZXJpYWxpemVkKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGNhY2hlIGNvbXBsZXRpb246XCIsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhY2hlIHN0cmVhayBkYXRhXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBjYWNoZVN0cmVhayhzdHJlYWs6IEhhYml0U3RyZWFrKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYCR7T2ZmbGluZVN0cmVha1NlcnZpY2UuQ0FDSEVfUFJFRklYfXN0cmVha18ke3N0cmVhay51c2VySWR9XyR7c3RyZWFrLmhhYml0SWR9YDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gU2VyaWFsaXplIHRpbWVzdGFtcHMgZm9yIHN0b3JhZ2VcbiAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSB7XG4gICAgICAgICAgICAgICAgLi4uc3RyZWFrLFxuICAgICAgICAgICAgICAgIG1pbGVzdG9uZXM6IHN0cmVhay5taWxlc3RvbmVzLm1hcCgobSkgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgLi4ubSxcbiAgICAgICAgICAgICAgICAgICAgYWNoaWV2ZWRBdDogbS5hY2hpZXZlZEF0LnRvTWlsbGlzKCksXG4gICAgICAgICAgICAgICAgfSkpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgYXdhaXQgQXN5bmNTdG9yYWdlLnNldEl0ZW0oY2FjaGVLZXksIEpTT04uc3RyaW5naWZ5KHNlcmlhbGl6ZWQpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY2FjaGUgc3RyZWFrOlwiLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWNoZSBjYWxlbmRhciBkYXRhXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBjYWNoZUNhbGVuZGFyKFxuICAgICAgICBoYWJpdElkOiBzdHJpbmcsXG4gICAgICAgIHVzZXJJZDogc3RyaW5nLFxuICAgICAgICBjYWxlbmRhcjogYW55LFxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBjYWNoZUtleSA9IGAke09mZmxpbmVTdHJlYWtTZXJ2aWNlLkNBQ0hFX1BSRUZJWH1jYWxlbmRhcl8ke3VzZXJJZH1fJHtoYWJpdElkfWA7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSB7XG4gICAgICAgICAgICAgICAgY2FsZW5kYXIsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgYXdhaXQgQXN5bmNTdG9yYWdlLnNldEl0ZW0oY2FjaGVLZXksIEpTT04uc3RyaW5naWZ5KHNlcmlhbGl6ZWQpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY2FjaGUgY2FsZW5kYXI6XCIsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBjYWxlbmRhciBmcm9tIGNhY2hlXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBnZXRDYWxlbmRhckZyb21DYWNoZShoYWJpdElkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYCR7T2ZmbGluZVN0cmVha1NlcnZpY2UuQ0FDSEVfUFJFRklYfWNhbGVuZGFyXyR7dXNlcklkfV8ke2hhYml0SWR9YDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVkRGF0YSA9IGF3YWl0IEFzeW5jU3RvcmFnZS5nZXRJdGVtKGNhY2hlS2V5KTtcbiAgICAgICAgICAgIGlmIChjYWNoZWREYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShjYWNoZWREYXRhKTtcblxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGNhY2hlIGlzIG5vdCB0b28gb2xkICgyNCBob3VycylcbiAgICAgICAgICAgICAgICBjb25zdCBjYWNoZUFnZSA9IERhdGUubm93KCkgLSBwYXJzZWQudGltZXN0YW1wO1xuICAgICAgICAgICAgICAgIGlmIChjYWNoZUFnZSA8IDI0ICogNjAgKiA2MCAqIDEwMDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlZC5jYWxlbmRhcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGdldCBjYWxlbmRhciBmcm9tIGNhY2hlOlwiLCBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZXR1cm4gZW1wdHkgY2FsZW5kYXIgaWYgbm8gdmFsaWQgY2FjaGVcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsZWFyIGFsbCBjYWNoZWQgZGF0YSBmb3IgYSB1c2VyXG4gICAgICovXG4gICAgYXN5bmMgY2xlYXJVc2VyQ2FjaGUodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIEdldCBhbGwga2V5cyBhbmQgZmlsdGVyIGZvciB0aGlzIHVzZXJcbiAgICAgICAgICAgIGNvbnN0IGFsbEtleXMgPSBhd2FpdCBBc3luY1N0b3JhZ2UuZ2V0QWxsS2V5cygpO1xuICAgICAgICAgICAgY29uc3QgdXNlcktleXMgPSBhbGxLZXlzLmZpbHRlcihcbiAgICAgICAgICAgICAgICAoa2V5KSA9PlxuICAgICAgICAgICAgICAgICAgICBrZXkuc3RhcnRzV2l0aChPZmZsaW5lU3RyZWFrU2VydmljZS5DQUNIRV9QUkVGSVgpICYmXG4gICAgICAgICAgICAgICAgICAgIGtleS5pbmNsdWRlcyh1c2VySWQpLFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKHVzZXJLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBBc3luY1N0b3JhZ2UubXVsdGlSZW1vdmUodXNlcktleXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBjbGVhciB1c2VyIGNhY2hlOlwiLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY2FjaGUgc3RhdGlzdGljc1xuICAgICAqL1xuICAgIGFzeW5jIGdldENhY2hlU3RhdHModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICAgICAgdG90YWxJdGVtczogbnVtYmVyO1xuICAgICAgICB0b3RhbFNpemU6IG51bWJlcjtcbiAgICAgICAgbGFzdFVwZGF0ZWQ6IG51bWJlciB8IG51bGw7XG4gICAgfT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgYWxsS2V5cyA9IGF3YWl0IEFzeW5jU3RvcmFnZS5nZXRBbGxLZXlzKCk7XG4gICAgICAgICAgICBjb25zdCB1c2VyS2V5cyA9IGFsbEtleXMuZmlsdGVyKFxuICAgICAgICAgICAgICAgIChrZXkpID0+XG4gICAgICAgICAgICAgICAgICAgIGtleS5zdGFydHNXaXRoKE9mZmxpbmVTdHJlYWtTZXJ2aWNlLkNBQ0hFX1BSRUZJWCkgJiZcbiAgICAgICAgICAgICAgICAgICAga2V5LmluY2x1ZGVzKHVzZXJJZCksXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBsZXQgdG90YWxTaXplID0gMDtcbiAgICAgICAgICAgIGxldCBsYXN0VXBkYXRlZDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHVzZXJLZXlzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IEFzeW5jU3RvcmFnZS5nZXRJdGVtKGtleSk7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWxTaXplICs9IGRhdGEubGVuZ3RoO1xuXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC50aW1lc3RhbXAgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIWxhc3RVcGRhdGVkIHx8IHBhcnNlZC50aW1lc3RhbXAgPiBsYXN0VXBkYXRlZClcbiAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RVcGRhdGVkID0gcGFyc2VkLnRpbWVzdGFtcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgcGFyc2luZyBlcnJvcnMgZm9yIHRpbWVzdGFtcCBleHRyYWN0aW9uXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgdG90YWxJdGVtczogdXNlcktleXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgIHRvdGFsU2l6ZSxcbiAgICAgICAgICAgICAgICBsYXN0VXBkYXRlZCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGdldCBjYWNoZSBzdGF0czpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICB0b3RhbEl0ZW1zOiAwLFxuICAgICAgICAgICAgICAgIHRvdGFsU2l6ZTogMCxcbiAgICAgICAgICAgICAgICBsYXN0VXBkYXRlZDogbnVsbCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vIEV4cG9ydCBzaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBvZmZsaW5lU3RyZWFrU2VydmljZSA9IG5ldyBPZmZsaW5lU3RyZWFrU2VydmljZSgpO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQU9BLElBQUFBLGFBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFVBQUEsR0FBQUQsT0FBQTtBQUVBLElBQUFFLGNBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLGNBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLFlBQUEsR0FBQUosT0FBQTtBQUE0QyxJQUsvQkssb0JBQW9CLEdBQUFDLE9BQUEsQ0FBQUQsb0JBQUE7RUFJN0IsU0FBQUEscUJBQUEsRUFBYztJQUFBLElBQUFFLGdCQUFBLENBQUFDLE9BQUEsUUFBQUgsb0JBQUE7SUFDVixJQUFJLENBQUNJLGFBQWEsR0FBRyxJQUFJQyw0QkFBYSxDQUFDLENBQUM7RUFDNUM7RUFBQyxXQUFBQyxhQUFBLENBQUFILE9BQUEsRUFBQUgsb0JBQUE7SUFBQU8sR0FBQTtJQUFBQyxLQUFBO01BQUEsSUFBQUMsaUJBQUEsT0FBQUMsa0JBQUEsQ0FBQVAsT0FBQSxFQU1ELFdBQ0lRLFVBQXVDLEVBQ2Y7UUFDeEIsSUFBTUMsTUFBTSxTQUFTLElBQUFDLHVCQUFRLEVBQUMsQ0FBQztRQUUvQixJQUFJRCxNQUFNLEVBQUU7VUFDUixJQUFJO1lBRUEsSUFBTUUsTUFBTSxTQUFTLElBQUksQ0FBQ1YsYUFBYSxDQUFDVyxnQkFBZ0IsQ0FBQ0osVUFBVSxDQUFDO1lBR3BFLE1BQU0sSUFBSSxDQUFDSyxlQUFlLENBQUNGLE1BQU0sQ0FBQztZQUVsQyxPQUFPQSxNQUFNO1VBQ2pCLENBQUMsQ0FBQyxPQUFPRyxLQUFLLEVBQUU7WUFDWkMsT0FBTyxDQUFDQyxJQUFJLENBQ1IseURBQXlELEVBQ3pERixL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